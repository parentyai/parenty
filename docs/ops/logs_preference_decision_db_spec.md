# Parenty｜ログ・嗜好・判断データベース設計資料（SSOT従属・非仕様）

本書は仕様ではない。
本書は定義・権威・判断の正を持たない。
本書は SSOT / PolicyUxAdminMatrix / 下位仕様を変更・補完・再定義しない。
矛盾がある場合は、常に SSOT / PolicyUxAdminMatrix が優先される。
本書を根拠に実装・仕様変更・運用判断を行ってはならない。
本書単体で仕様判断してはならず、判断起点は PolicyUxAdminMatrix にあり、SSOT/Matrix が常に優先される。

## メタ（固定）

- **SSoT責務**: ログ/嗜好/判断DBの設計合意を、SSOT参照で固定する（仕様の追加はしない）。
- **想定読者**: Engineer / Ops / Legal
- **依存SSoT**: `PARENTY_SSOT.md`（4-2-a / 4-2-b / 7章 / 8-5）
- **参照導線**: `SSOT_INDEX.md` / `PolicyUxAdminMatrix.md` / `docs/INTEGRITY_CHECKLIST.md`
- **更新ルール**: FROZEN文書のため、改変時は再凍結フロー（決裁→チェックリスト→Status更新）を必須とする。

---

## 背景

- 本資料の詳細背景は「1. 背景」に固定する。

## 説明

- 設計の詳細説明は各章の「説明」小節に固定する。

## 結論

- 本資料の結論は各章の「結論」小節に従う。

## 補足

- 補足は各章の「補足」小節に従う。

---

位置づけ
- 本文書は SSOT（`PARENTY_SSOT.md`）に従属する設計資料である。
- 本文書は 仕様ではなく、実装前の設計合意を目的とする。
- 本文書が凍結されるまで 実装は禁止。
- 凍結後も、本資料は SSOT を上書きしない。

---

## 1. 背景

### 背景
- Parenty の通知/会話/FAQ/スケジュールに関わるログ・嗜好・判断の扱いを設計資料として整理する。

### 説明
- 決定事項: 本資料はログ/嗜好/判断DBの設計合意に必要な情報を集約する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 設計合意と凍結判断のための基礎資料として本資料を用いる。

### 補足
- なし。

---

## 2. 目的とスコープ

### 背景
- 目的と対象範囲を固定し、実装前の逸脱を防ぐ。

### 説明
- 決定事項: 対象は行動ログ、嗜好ログ、判断ログ、短期記憶、監査ログの設計である。詳細は第9章と第10章に集約する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 本資料はログ/嗜好/判断DBに限定する。

### 補足
- なし。

---

## 3. 本文書の位置づけ（SSOTとの関係）

### 背景
- SSOT との関係を固定し、権威の混在を防ぐ。

### 説明
- 決定事項: 冒頭の位置づけに従い、本資料は SSOT に従属する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 本資料は SSOT を上書きしない。

### 補足
- なし。

---

## 4. 設計原則（法務・倫理・UX・LLM運用）

### 背景
- 法務・倫理・UX・LLM運用の原則を固定し、設計の逸脱を防ぐ。

### 説明
- 決定事項:
  - 目的限定・最小化・同意・保持期限・分離保管・監査可能性を前提とする。
  - 子ども関連は強い同意・短期保持を前提とする。
  - 生の会話全文や自由記述を長期保存しない。保存が必要な場合は条件を明文化し、デフォルトは要約/特徴量のみとする。
  - payload は最小とし、識別子はハッシュ化/分離する。
  - 推定情報を保存する場合は理由・精度・用途・期限・オプトアウトを必須項目とする。現行は保存しない。
  - 目的外利用（広告、第三者提供、モデル学習転用）は前提にしない。
  - すべてのデータに「目的」「保持期限」「参照主体」「削除条件」を付与する。
  - 例外処理（法的請求、セキュリティインシデント、監査）は最小限の長期ログに限定する。
  - 判断主体は常に人間とし、LLMは補助に限定する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 設計原則は本資料の全章に適用する。

### 補足
- なし。

---

## 5. 決定事項サマリー（一覧）

### 背景
- 決定事項を一覧化し、参照導線を固定する。

### 説明
- 決定事項:
  - 保存禁止リストは第6章に固定する。
  - データ分類は第7章に固定する。
  - 3層構造は第8章に固定する。
  - コレクション構成は第9章に固定する。
  - コレクション仕様は第10章に固定する。
  - 判断ログ仕様は第11章に固定する。
  - 権限運用は第12章に固定する。
  - TTL/削除は第13章に固定する。
  - LLM利用仕様は第14章に固定する。
  - 管理UI利用は第15章に固定する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 決定事項の参照位置は本章に固定する。

### 補足
- なし。

---

## 6. 保存禁止リスト（明示）

### 背景
- 保存禁止事項を明示し、逸脱保存を防ぐ。

### 説明
- 決定事項:
  - 会話全文の長期保存は禁止する。
  - 自由記述の生テキスト長期保存は禁止する。
  - 子どもの推定年齢・健康状態・学習能力の推定値保存は禁止する。
  - マーケ目的の利用・第三者提供・モデル学習転用は禁止する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 保存禁止リストは本章に固定する。

### 補足
- なし。

---

## 7. データ分類ポリシー

### 背景
- データ分類の定義と扱いを固定する。

### 説明
- 決定事項:

| カテゴリ | 定義 | 例 | 保存可否 | PII分類 | 保持期限 | 参照権限 |
|---|---|---|---|---|---|---|
| Direct PII | 直接識別子 | 氏名、電話、住所 | 原則不可 | Direct | 0日 | なし |
| Child PII | 子ども識別情報 | 子ども氏名、学籍ID | 原則不可 | Child-Direct | 0日 | なし |
| Pseudonymous | ハッシュ化識別子 | household_hash | 可 | Pseudo | 365日 | Admin/Batch |
| Sensitive Inference | 推定情報 | 生活困窮推定 | 原則不可 | Sensitive | 0日 | なし |
| Behavior Log | 行動履歴 | 通知開封、FAQ閲覧 | 可（最小） | Pseudo | 30日 | User/Admin |
| Preference | 嗜好・設定 | 通知頻度、NGカテゴリ | 可（同意必須） | Pseudo | 同意中 | User/Admin |
| Decision Log | 判断記録 | reasonCode、decisionId | 可 | Pseudo | 180日 | Admin |

- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 分類定義は本章の表に従う。

### 補足
- なし。

---

## 8. データ保持の3層構造

### 背景
- 保持目的と期限の層を固定する。

### 説明
- 決定事項:

| 層 | 目的 | 保持 | 例 |
|---|---|---|---|
| 短期UX | 直近状態の整合 | 7〜30日 | 直近通知の既読、直近FAQ参照 |
| 同意パーソナライズ | 同意に基づく軽量嗜好 | 同意中のみ | 通知頻度、NGカテゴリ |
| 監査安全 | 事故調査・説明責任 | decision_logs 180日 / audit_logs 7年（SSOT 7-3-3 に従う） | reasonCode、human override |

- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 保持層の定義は本章の表に従う。

### 補足
- なし。

---

## 9. コレクション構成一覧

### 背景
- コレクション構成と参照導線を固定する。

### 説明
- 決定事項:

| Collection | 目的 | 保持 | 参照権限 | 主キー | 検索キー |
|---|---|---|---|---|---|
| event_logs | 行動ログ | 30日 | User/Admin/Batch | eventId | householdHash, eventType, createdAt |
| preference_profile | 嗜好・同意 | 同意中 | User/Admin | householdHash | consentStatus, updatedAt |
| decision_logs | 判断ログ | 180日 | Admin/Batch | decisionId | reasonCode, householdHash, createdAt |
| memory_store | 短期UX記憶 | 7日 | User/Batch | memoryId | householdHash, memoryType |
| audit_logs | 監査 | 7年（SSOT 7-3-3 に従う） | Admin | auditId | actorId, actionType, createdAt |

- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- コレクション構成は本章の表に従う。

### 補足
- なし。

---

## 10. 各コレクション仕様（詳細表）

### 背景
- フィールド単位の扱いを固定する。

### 説明
- 決定事項:

**event_logs**
| フィールド名 | 型 | 例 | 保存可否 | PII分類 | 保持期限 | 参照権限 |
|---|---|---|---|---|---|---|
| eventId | string | evt_20260101_001 | 可 | Pseudo | 30日 | Admin/Batch |
| householdHash | string | hh_9f3a | 可 | Pseudo | 30日 | User/Admin |
| eventType | string | NOTIF_OPEN | 可 | None | 30日 | User/Admin |
| channel | string | LINE | 可 | None | 30日 | Admin |
| createdAt | timestamp | 2026-01-10T09:00:00Z | 可 | None | 30日 | Admin |
| payloadSummary | string | 通知を開封 | 可 | None | 30日 | Admin |
| rawText | string | （禁止） | 不可 | Direct | 0日 | なし |

**preference_profile**
| フィールド名 | 型 | 例 | 保存可否 | PII分類 | 保持期限 | 参照権限 |
|---|---|---|---|---|---|---|
| householdHash | string | hh_9f3a | 可 | Pseudo | 同意中 | User/Admin |
| consentStatus | string | ON/OFF | 可 | None | 同意中 | User/Admin |
| notifyFrequency | string | DAILY | 可 | None | 同意中 | User/Admin |
| blockedTopics | array<string> | ["finance","legal"] | 可 | None | 同意中 | User/Admin |
| consentUpdatedAt | timestamp | 2026-01-10T09:00:00Z | 可 | None | 同意中 | Admin |
| consentRevokedAt | timestamp | 2026-01-12T09:00:00Z | 可 | None | 同意終了時 | Admin |

**decision_logs**
| フィールド名 | 型 | 例 | 保存可否 | PII分類 | 保持期限 | 参照権限 |
|---|---|---|---|---|---|---|
| decisionId | string | dec_20260110_002 | 可 | Pseudo | 180日 | Admin |
| householdHash | string | hh_9f3a | 可 | Pseudo | 180日 | Admin |
| reasonCode | string | RISK_POLICY_PROHIBITED | 可 | None | 180日 | Admin |
| nextAction | string | OPEN_SUPPORT | 可 | None | 180日 | Admin |
| decisionSource | string | HUMAN/LLM/DETERMINISTIC | 可 | None | 180日 | Admin |
| humanOverride | boolean | true | 可 | None | 180日 | Admin |
| llmSummary | string | 120字以内 | 可 | None | 30日 | Admin |
| rawPrompt | string | （禁止） | 不可 | Sensitive | 0日 | なし |

**memory_store**
| フィールド名 | 型 | 例 | 保存可否 | PII分類 | 保持期限 | 参照権限 |
|---|---|---|---|---|---|---|
| memoryId | string | mem_20260110_001 | 可 | Pseudo | 7日 | User/Batch |
| householdHash | string | hh_9f3a | 可 | Pseudo | 7日 | User |
| memoryType | string | LAST_STATE | 可 | None | 7日 | User |
| memoryValue | string | STATE_3 | 可 | None | 7日 | User |
| expiresAt | timestamp | 2026-01-17T09:00:00Z | 可 | None | 7日 | Batch |

**audit_logs**
| フィールド名 | 型 | 例 | 保存可否 | PII分類 | 保持期限 | 参照権限 |
|---|---|---|---|---|---|---|
| auditId | string | aud_20260110_001 | 可 | Pseudo | 7年（SSOT 7-3-3 に従う） | Admin |
| actorType | string | admin/system/guardian | 可 | None | 7年 | Admin |
| actionType | string | TEMPLATE_DISABLE | 可 | None | 7年 | Admin |
| targetId | string | tpl_123 | 可 | None | 7年 | Admin |
| reasonCode | string | RISK_TEMPLATE_HIGH | 可 | None | 7年 | Admin |
| createdAt | timestamp | 2026-01-10T09:00:00Z | 可 | None | 7年 | Admin |

- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- フィールド仕様は本章の表に従う。

### 補足
- なし。

---

## 11. 判断ログ / reasonCode 設計

### 背景
- 判断の監査要件を固定する。

### 説明
- 決定事項:

| 項目 | 必須 | 説明 | 例 |
|---|---|---|---|
| decisionId | 必須 | 判断単位ID | dec_20260110_002 |
| reasonCode | 必須 | 判断根拠コード | RISK_POLICY_PROHIBITED |
| decisionSource | 必須 | 判断主体区分 | HUMAN |
| humanOverride | 必須 | 人手介入の有無 | true |
| asOf | 必須 | 判断時点 | 2026-01-10T09:00:00Z |
| evidenceRef | 必須 | 根拠参照ID | src_001 |

- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 判断ログの最小項目は本章の表に従う。

### 補足
- なし。

---

## 12. 参照・更新権限と運用ルール

### 背景
- 参照権限と更新主体を固定する。

### 説明
- 決定事項:
  - User: 自身の householdHash の preference_profile と memory_store を参照する。event_logs と decision_logs の参照は不可とする。
  - Admin: decision_logs と audit_logs を参照する。PIIはマスキング済みのビューのみとする。
  - Batch: TTL削除と集計ジョブのみ実行する。読み取り対象は Pseudonymous のみとする。
  - LLM: decision_logs の要約済み参照のみ許可する。rawPrompt・rawText の参照は禁止する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 参照・更新権限は本章に固定する。

### 補足
- なし。

---

## 13. リテンション（TTL）と削除フロー

### 背景
- 保持期限と削除条件を固定する。

### 説明
- 決定事項:
  - 同意撤回: preference_profile を即時無効化し、関連する推定値は即時削除する。
  - アカウント削除: householdHash の紐付けを全コレクションで削除する。
  - 目的達成後削除: memory_store は期限到達で削除、event_logs は30日で削除する。
  - audit_logs の保持は SSOT 7-3-3 に従う。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- TTLと削除フローは本章に固定する。

### 補足
- なし。

---

## 14. LLM 利用仕様（参照・保存・安全制御）

### 背景
- LLMの参照範囲と保存範囲を固定する。

### 説明
- 決定事項:
  - 参照データ最小セット: preference_profile（同意ONのみ）、memory_store、decision_logs（要約のみ）。
  - 生成物の保存は要約 + reasonCode のみとし、全文保存は禁止する。
  - 安全フィルタ: 医療/法務断定、年齢推定、個別推薦を検知した場合は保存拒否する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- LLM利用仕様は本章に固定する。

### 補足
- なし。

---

## 15. 管理UIでの利用想定

### 背景
- 管理UIでの利用範囲を固定する。

### 説明
- 決定事項:
  - 閲覧画面は decision_logs / audit_logs のみとする。
  - 検索キーは reasonCode, createdAt, actorType とする。
  - householdHash は表示不可とし、集計値のみ表示する。
- 【未決事項】: なし。
- リスク: 第18章参照。
- テスト観点: 第16章参照。

### 結論
- 管理UI利用は本章に固定する。

### 補足
- なし。

---

## 16. テストケース・検証観点

### 背景
- 保存禁止と権限の逸脱を検知する。

### 説明
- 決定事項:

| Given | When | Then |
|---|---|---|
| 同意OFF | preference_profile参照 | 読み取り拒否 |
| rawText含むpayload | event_logs書き込み | 失敗 |
| 30日経過 | event_logs TTL | 自動削除 |
| decisionSource=LLM | 保存処理 | humanOverride必須 |
| child PII含有 | any collection書込 | 拒否 |

逸脱検知ルール
- rawText を payload に含めた場合は書き込み拒否する。
- 自由記述が payload に含まれた場合は書き込み拒否する。
- child PII が含まれる場合は書き込み拒否する。

- 【未決事項】: なし。
- リスク: 第18章参照。

### 結論
- テストケースは本章に固定する。

### 補足
- なし。

---

## 17. 未決事項（質問と暫定案）

### 背景
- 凍結前の決裁事項を一覧化する。

### 説明
- 決定事項:
  - 同意主体の粒度: 家庭単位ベース＋保護者上書き可（発効日: 2026-01-10）
  - 監査ログの最長保持年数: 7年（SSOT 7-3-3）（発効日: 2026-01-10）
  - 監査安全の最長保持期限: decision_logs 180日 / audit_logs 7年（発効日: 2026-01-10）
  - 例外処理の最長保持期限: audit_logs と同一（7年）（発効日: 2026-01-10）
  - LLM要約の最大文字数: 120字固定（発効日: 2026-01-10）
  - 監査ログの外部保管要件: 外部保管は行わない（発効日: 2026-01-10）
  - preference_profile の配置先: 単独コレクション（householdHash主キー）（発効日: 2026-01-10）
  - 物理コレクション名: SSOT 4章の正式名に整合し、凍結時に正式名へ置換（発効日: 2026-01-10）

### 結論
- 本章の決裁が凍結条件の前提となる。

### 補足
- なし。

---

## 18. リスク一覧（技術／運用／法務）

### 背景
- 主要リスクを分類し、対策の参照点を固定する。

### 説明
- リスク一覧:

| 区分 | リスク | 対策 |
|---|---|---|
| 技術 | rawText保存混入 | 書き込みバリデーションで拒否 |
| 技術 | TTL未実行 | TTLジョブ監視と失敗アラート |
| 技術 | ハッシュ衝突 | UUID + salt で固定 |
| 運用 | 同意OFF参照 | 参照ガードと監査ログ |
| 運用 | decision_logs長期保持 | 180日固定、監査確認 |
| 運用 | admin権限過大 | 役割分離と閲覧制限 |
| 法務 | child PII混入 | PII分類フィルタで拒否 |
| 法務 | LLM要約にPII含有 | 要約フィルタで拒否 |
| 法務 | 目的外利用 | 目的ラベル必須化 |
| 法務 | 監査ログ匿名化不備 | マスキング前提の閲覧制御 |

### 結論
- リスク管理は本章の一覧を起点とする。

### 補足
- なし。

---

## 19. 仕様フリーズ条件チェックリスト

### 背景
- 凍結可否を機械的に判定する。

### 説明
- チェックリスト:

| 項目 | Yes/No |
|---|---|
| 同意主体の粒度が確定している | Yes |
| 監査ログの保持期限が確定している | Yes |
| LLM要約の最大文字数が確定している | Yes |
| 参照権限が全ロールで確定している | Yes |
| TTLが全コレクションで確定している | Yes |
| 保存禁止リストが全員合意済み | Yes |

### 結論
- No が残る限り凍結不可とする。

### 補足
- なし。

---

## 20. 実装前レビュー会アジェンダ

### 背景
- 凍結前に合意ポイントを整理する。

### 説明
- アジェンダ:
  1. データ分類と保存禁止リスト確認（15分）
  2. 参照権限・監査ログの合意（15分）
  3. LLM利用仕様・要約保存の合意（15分）
  4. TTL/削除フローの合意（15分）

### 結論
- アジェンダは本章に固定する。

### 補足
- なし。

---

## 21. 結論（現状ステータスと次の一手）

### 背景
- 凍結までの現状と次の一手を固定する。

### 説明
- 現状ステータス: Status: FROZEN (2026-01-10)
- 次の一手: なし。

### 結論
- 凍結条件を満たすまで実装は行わない。

### 補足
- なし。

---

本文書は、Parenty におけるログ・嗜好・判断データの
安全な取り扱いと高品質なUXを両立するための
SSOT従属・非仕様の設計資料である。
本文書が凍結されるまで、実装は行ってはならない。
